# Parameters:
# configs_src: Root directory for configuration files
# config_dest: Destination path on the target host for configuration files
# host: Name of the folder containing host-specific configuration files

---
- name: Multi-host configuration deployment
  block:
    - name: Find all service directories under configs/
      find:
        paths: "{{ configs_src }}"
        file_type: directory
        depth: 1
      delegate_to: localhost
      register: service_dirs

    - name: Check if each service has host-specific config
      stat:
        path: "{{ item.path }}/{{ host }}"
      delegate_to: localhost
      register: service_config
      loop: "{{ service_dirs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Sync config files to host
      ansible.posix.synchronize:
        src: "{{ item.item.path }}/{{ host }}/" # local folder of configs
        dest: "{{ config_dest }}/{{ item.item.path | basename }}/" # destination on host
        delete: true # remove files not in src
        recursive: true
      loop: "{{ service_config.results }}"
      when: item.stat.exists
      loop_control:
        label: "{{ item.item.path | basename }}"
      register: config_copy
